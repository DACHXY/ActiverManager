<!DOCTYPE html>
<html>

<head>
  <title>ActiverManager</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
</head>

<body>
  <div class="container my-3">
    <h1>ActiverManager</h1>

    <!-- Accordion -->
    <div id="accordion">
      {% for server in servers %}
      <div class="card">
        <div class="card-header" id="heading{{ server.id }}">
          <h5 class="mb-0">
            <button class="btn btn-link" data-toggle="collapse" data-target="#collapse{{ server.id }}" aria-expanded="true"
              aria-controls="collapse{{ server.id }}">
              {{ server.servername }}
            </button>
            <span class="badge badge-pill {{ 'badge-success' if server.is_alive else 'badge-secondary' }}"> {{ 'Online' if server.is_alive else 'Offline' }} </span>
            <div>
          </h5>
        </div>
        <div id="collapse{{ server.id }}" class="collapse {% if loop.index == 1 %}show{% endif %}" aria-labelledby="heading{{ server.id }}" data-parent="#accordion">
          <div class="card-body">
            {{ server.exec_cmd }}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Add Accordion Button -->
    <button type="button" id="add-accordion" data-toggle="modal" data-target="#exampleModal"
      class="btn btn-primary mt-3">Add New Server</button>
  </div>

  <!-- 新增伺服器 Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">新增資料</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group">
              <label for="server-name" class="col-form-label">名稱:</label>
              <input type="text" class="form-control" id="server-name">
            </div>
            <div class="form-group">
              <label for="command" class="col-form-label">CMD指令:</label>
              <input type="text" class="form-control" id="command">
            </div>
            <div class="form-group">
              <label for="path" class="col-form-label">執行路徑:</label>
              <input type="text" class="form-control" id="path">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
          <button id="add-new-server-button" type="button" class="btn btn-primary">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

  <script>
    // 送出保存伺服器請求
    function saveData() {
      // 從表單中獲取輸入的值
      const serverName = document.querySelector("#server-name").value;
      const command = document.querySelector("#command").value;
      const path = document.querySelector("#path").value;

      if (serverName.value === "" || command.value === "" || command.value === "") {
        alert("請填寫完整表單！");
        return;
      }

      // 使用 fetch 函數發送 POST 請求
      fetch("/add", {
        method: "POST",
        body: JSON.stringify({ 
          servername: serverName, 
          exec_cmd: command, 
          cwd: path 
        }),
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error("儲存失敗");
          }
          // 儲存成功，關閉彈出窗口
          $("#myModal").modal("hide");
          alert("儲存成功");
        })
        .catch(error => {
          console.error(error);
          alert("儲存失敗");
        });
    }

    // 綁定按鈕的 click 事件
    document.querySelector("#add-new-server-button").addEventListener("click", saveData);
  </script>